name: Release Template

on:
  workflow_call:
    inputs:
      target:
        description: Build target directory name
        required: true
        type: string
      tag:
        description: Release tag name
        required: true
        type: string
      release_asset:
        description: Relative path to selected binary inside repository workspace
        required: true
        type: string
      upload_release:
        description: Upload selected binary to GitHub Release
        required: false
        default: true
        type: boolean
      no_cache:
        description: Build without cache
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache buildkit
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/${{ inputs.target }}/.cache
          key: buildkit-${{ inputs.target }}-${{ hashFiles(format('{0}/Dockerfile', inputs.target), format('{0}/.env', inputs.target)) }}
          restore-keys: |
            buildkit-${{ inputs.target }}-

      - name: Build target
        run: |
          if [ "${{ inputs.no_cache }}" = "true" ]; then
            make build-no-cache TARGET=${{ inputs.target }}
          else
            make build TARGET=${{ inputs.target }}
          fi

      - name: Upload full build output artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target }}-static-build
          path: ${{ inputs.target }}/output/
          if-no-files-found: error
          retention-days: 30

      - name: Generate checksums for output directory
        if: ${{ inputs.upload_release }}
        run: |
          TARGET="${{ inputs.target }}"
          TAG="${{ inputs.tag }}"
          OUTPUT_DIR="${TARGET}/output"
          CHECKSUM_FILE="${TARGET}-${TAG}.sha256"
          
          if [ ! -d "${OUTPUT_DIR}" ]; then
            echo "Error: Output directory not found at ${OUTPUT_DIR}"
            exit 1
          fi
          
          # Generate checksums for all files in output directory
          (cd "${OUTPUT_DIR}" && find . -type f -exec sha256sum {} + | sed 's|^\./||' > "${CHECKSUM_FILE}")
          
          # Move checksum file to workspace root for upload
          mv "${OUTPUT_DIR}/${CHECKSUM_FILE}" "${CHECKSUM_FILE}"

      - name: Create tar.gz archive of output directory
        if: ${{ inputs.upload_release }}
        run: |
          TARGET="${{ inputs.target }}"
          TAG="${{ inputs.tag }}"
          OUTPUT_DIR="${TARGET}/output"
          ARCHIVE_NAME="${TARGET}-${TAG}.tar.gz"
          
          if [ ! -d "${OUTPUT_DIR}" ]; then
            echo "Error: Output directory not found at ${OUTPUT_DIR}"
            exit 1
          fi
          
          # Create tar.gz archive
          tar -czf "${ARCHIVE_NAME}" -C "${TARGET}" output

      - name: Publish assets to release
        if: ${{ inputs.upload_release }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TARGET="${{ inputs.target }}"
          TAG="${{ inputs.tag }}"
          RELEASE_ASSET="${{ inputs.release_asset }}"
          BINARY_NAME="${TARGET}-${TAG}"
          ARCHIVE_NAME="${TARGET}-${TAG}.tar.gz"
          CHECKSUM_NAME="${TARGET}-${TAG}.sha256"
          
          # Verify all assets exist
          if [ ! -f "${RELEASE_ASSET}" ]; then
            echo "Error: Release asset not found at ${RELEASE_ASSET}"
            exit 1
          fi
          
          if [ ! -f "${ARCHIVE_NAME}" ]; then
            echo "Error: Archive not found at ${ARCHIVE_NAME}"
            exit 1
          fi
          
          if [ ! -f "${CHECKSUM_NAME}" ]; then
            echo "Error: Checksum file not found at ${CHECKSUM_NAME}"
            exit 1
          fi
          
          # Create release if it doesn't exist
          if ! gh release view "${TAG}" >/dev/null 2>&1; then
            gh release create "${TAG}" \
              --title "${TAG}" \
              --notes "Automated static binary release from tag ${TAG}."
          fi
          
          # Upload all assets with proper names
          gh release upload "${TAG}" "${RELEASE_ASSET}#${BINARY_NAME}" --clobber
          gh release upload "${TAG}" "${ARCHIVE_NAME}" --clobber
          gh release upload "${TAG}" "${CHECKSUM_NAME}" --clobber
