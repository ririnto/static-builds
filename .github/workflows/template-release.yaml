name: Release Template

on:
  workflow_call:
    inputs:
      target:
        description: Build target directory name
        required: true
        type: string
      tag:
        description: Release tag name
        required: true
        type: string
      release_files:
        description: Newline-separated relative paths to files to include in release package
        required: true
        type: string
      upload_release:
        description: Upload selected binary to GitHub Release
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache source downloads
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/${{ inputs.target }}/src
          key: src-${{ inputs.target }}-${{ hashFiles(format('{0}/.env', inputs.target), format('{0}/download.sh', inputs.target), '.github/scripts/common.sh') }}
          restore-keys: |-
            src-${{ inputs.target }}-

      - name: Cache buildkit
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/${{ inputs.target }}/.cache
          key: buildkit-${{ inputs.target }}-${{ hashFiles(format('{0}/Dockerfile', inputs.target), format('{0}/.env', inputs.target)) }}
          restore-keys: |-
            buildkit-${{ inputs.target }}-

      - name: Build target
        run: make build ${{ inputs.target }}

      - name: Upload selected release files artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target }}-static-build
          path: ${{ inputs.release_files }}
          if-no-files-found: error
          retention-days: 30

      - name: Create release package
        if: ${{ inputs.upload_release }}
        run: |-
          TAG="${{ inputs.tag }}"
          PACKAGE_NAME="${TAG}.tar.gz"
          RELEASE_PATHS=()

          rm -f "${PACKAGE_NAME}"

          while IFS= read -r release_file; do
            if [ -z "${release_file}" ]; then
              continue
            fi

            if [ -f "${release_file}" ] || [ -d "${release_file}" ]; then
              RELEASE_PATHS+=("${release_file}")

            else
              echo "Error: Release path not found at ${release_file}"
              exit 1
            fi
          done << 'EOF'
          ${{ inputs.release_files }}
          EOF

          if [ "${#RELEASE_PATHS[@]}" -eq 0 ]; then
            echo "Error: No release files provided"
            exit 1
          fi

          tar -czvf "${PACKAGE_NAME}" "${RELEASE_PATHS[@]}"

      - name: Publish assets to release
        if: ${{ inputs.upload_release }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |-
          TAG="${{ inputs.tag }}"
          PACKAGE_NAME="${TAG}.tar.gz"
          
          # Verify all assets exist
          if [ ! -f "${PACKAGE_NAME}" ]; then
            echo "Error: Release package not found at ${PACKAGE_NAME}"
            exit 1
          fi
          
          # Create release if it doesn't exist
          if ! gh release view "${TAG}" >/dev/null 2>&1; then
            gh release create "${TAG}" \
              --title "${TAG}" \
              --notes "Automated static binary release from tag ${TAG}."
          fi
          
          gh release upload "${TAG}" "${PACKAGE_NAME}" --clobber
