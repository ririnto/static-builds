# Lua Module Embedding

This build embeds required Lua modules directly into the nginx binary as bytecode. No `.lua` files are shipped in the final image.

## Why Embed

The healthcheck module and its runtime dependencies are compiled to LuaJIT bytecode and statically linked during the nginx build. This approach eliminates runtime file dependencies and keeps the release artifact fully static.

## How It Works

The build process follows these steps:

1. **Flatten module paths to file names** - Lua files under `lib/` are flattened with underscores so dot-separated `require` names map to file names.

2. **Compile to bytecode** - The LuaJIT compiler generates object files:

   ```bash
   luajit -bg resty_upstream_healthcheck.lua resty_upstream_healthcheck.o
   luajit -bg resty_core.lua resty_core.o
   luajit -bg resty_lrucache.lua resty_lrucache.o
   ```

   The `-b` flag produces bytecode and `-g` includes debug information.

3. **Link during nginx build** - All generated object files are linked directly into the nginx binary via the `--with-ld-opt` configure flag.

   ```bash
   --with-ld-opt="/build/resty_upstream_healthcheck.o -static -static-pie ..."
   ```

## Module Name Mapping

Lua modules use dot-separated names in `require()` calls but map to underscore-separated file names for LuaJIT compilation:

| Module Name | File Name |
| --- | --- |
| `resty.upstream.healthcheck` | `resty_upstream_healthcheck.lua` |
| `resty.core` | `resty_core.lua` |
| `resty.lrucache` | `resty_lrucache.lua` |

## LuaJIT Version Compatibility

The bytecode generated by LuaJIT is version-specific. The LuaJIT version used during compilation MUST match the LuaJIT version at runtime. This build locks both versions to the same Alpine package to ensure compatibility.

## Scope

This repository embeds `resty.upstream.healthcheck` and required runtime dependencies (`resty.core`, `resty.lrucache`) for a fully static runtime. Additional lua-resty libraries are not included.

## Reference

See `third-party/lua-nginx-module/README.markdown` (section "Statically Linking Pure Lua Modules") for the canonical documentation on this embedding technique.
