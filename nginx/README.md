# Lua Module Embedding

This build embeds `resty.upstream.healthcheck` into the nginx binary as bytecode, while packaging required runtime dependencies (`lua-resty-core`, `lua-resty-lrucache`) as Lua files.

## Why Embed

The healthcheck module is compiled to LuaJIT bytecode and statically linked during the nginx build. `lua-resty-core` is required by `lua-nginx-module` at VM init time, so its Lua files are packaged under `lib/lua` together with `lua-resty-lrucache`.

## How It Works

The build process follows these steps:

1. **Flatten module paths to file names** - Lua files under `lib/` are flattened with underscores so dot-separated `require` names map to file names.

2. **Compile to bytecode** - The LuaJIT compiler generates object files:

   ```bash
   luajit -bg resty_upstream_healthcheck.lua resty_upstream_healthcheck.o
   # healthcheck module is embedded
   luajit -bg resty_upstream_healthcheck.lua resty_upstream_healthcheck.o
   ```

   The `-b` flag produces bytecode and `-g` includes debug information.

3. **Link during nginx build** - The generated healthcheck object file is linked directly into the nginx binary via the `--with-ld-opt` configure flag.

   ```bash
   --with-ld-opt="/build/resty_upstream_healthcheck.o -static -static-pie ..."
   ```

## Module Name Mapping

Lua modules use dot-separated names in `require()` calls but map to underscore-separated file names for LuaJIT compilation:

| Module Name | File Name |
| --- | --- |
| `resty.upstream.healthcheck` | `resty_upstream_healthcheck.lua` |

## LuaJIT Version Compatibility

The bytecode generated by LuaJIT is version-specific. The LuaJIT version used during compilation MUST match the LuaJIT version at runtime. This build locks both versions to the same Alpine package to ensure compatibility.

## Scope

This repository embeds `resty.upstream.healthcheck` into the binary. `resty.core` and `resty.lrucache` are installed as runtime Lua files because `lua-nginx-module` requires `resty.core` during VM initialization. Additional lua-resty libraries are not included.

## Reference

See `third-party/lua-nginx-module/README.markdown` (section "Statically Linking Pure Lua Modules") for the canonical documentation on this embedding technique.
