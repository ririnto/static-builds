# Lua Module Embedding

This build embeds the `resty.upstream.healthcheck` Lua module directly into the nginx binary as bytecode. No `.lua` files are shipped in the final image.

## Why Embed

The healthcheck module is compiled to LuaJIT bytecode and statically linked during the nginx build. This approach eliminates runtime file dependencies and ensures the module is always available without requiring external Lua libraries.

## How It Works

The build process follows these steps:

1. **Rename the module file** - The source file `lib/resty/upstream/healthcheck.lua` is copied to `resty_upstream_healthcheck.lua`. LuaJIT requires dot-separated module names to use underscores in filenames.

2. **Compile to bytecode** - The LuaJIT compiler generates an object file:

   ```bash
   luajit -bg resty_upstream_healthcheck.lua resty_upstream_healthcheck.o
   ```

   The `-b` flag produces bytecode and `-g` includes debug information.

3. **Link during nginx build** - The object file is linked directly into the nginx binary via the `--with-ld-opt` configure flag:

   ```bash
   --with-ld-opt="/build/resty_upstream_healthcheck.o -static -static-pie ..."
   ```

## Module Name Mapping

Lua modules use dot-separated names in `require()` calls but must map to underscore-separated filenames for LuaJIT compilation:

| Module Name | File Name |
| --- | --- |
| `resty.upstream.healthcheck` | `resty_upstream_healthcheck.lua` |

## LuaJIT Version Compatibility

The bytecode generated by LuaJIT is version-specific. The LuaJIT version used during compilation MUST match the LuaJIT version at runtime. This build locks both versions to the same Alpine package to ensure compatibility.

## Scope

This repository embeds ONLY the `resty.upstream.healthcheck` library. Other lua-resty libraries are not included and must be managed separately if needed.

## Reference

See `third-party/lua-nginx-module/README.markdown` (section "Statically Linking Pure Lua Modules") for the canonical documentation on this embedding technique.
